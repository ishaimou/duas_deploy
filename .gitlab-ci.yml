---
stages:
  - deploy

variables:
  ANSIBLE_HOST_KEY_CHECKING: "False"
  VAULT_ADDR: "https://vault.example.com"

deploy_duas:
  stage: deploy
  image: williamyeh/ansible:alpine3
  before_script:
    - apk add --no-cache openssh-client python3 py3-pip curl jq
    - pip3 install hvac

    # Setup SSH
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "${SSH_PRIVATE_KEY}" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan -H ${TARGET_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true

    # Fetch Artifactory credentials from Vault
    - |
      export VAULT_TOKEN="${CI_JOB_JWT}"
      VAULT_RESPONSE=$(curl --silent --request GET \
        --header "X-Vault-Token: ${VAULT_TOKEN}" \
        "${VAULT_ADDR}/v1/secret/data/artifactory/duas")
      export ARTIFACTORY_USER=$(echo $VAULT_RESPONSE | jq -r '.data.data.username')
      export ARTIFACTORY_PASSWORD=$(echo $VAULT_RESPONSE | jq -r '.data.data.password')
  script:
    - cd ansible
    - |
      ansible-playbook -i inventory.ini \
        playbooks/duas.yml \
        -e "artifactory_user=${ARTIFACTORY_USER}" \
        -e "artifactory_password=${ARTIFACTORY_PASSWORD}" \
        -v
  only:
    - main
  when: manual
