---
stages:
  - deploy
  - rollback

variables:
  ANSIBLE_HOST_KEY_CHECKING: "False"
  VAULT_ADDR: "https://vault.example.com"

deploy_duas:
  stage: deploy
  image: williamyeh/ansible:alpine3
  before_script:
    - apk add --no-cache openssh-client python3 py3-pip
    - pip3 install ansible hvac
    - ansible-galaxy collection install community.hashi_vault

    # Setup SSH (key will be fetched by Ansible from Vault)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H ${TARGET_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - cd ansible
    - |
      ansible-playbook -i inventory.ini \
        playbooks/duas.yml \
        --tags deploy \
        -e "vault_addr=${VAULT_ADDR}" \
        -e "vault_token=${CI_JOB_JWT}" \
        -v
  only:
    - main
  when: manual

rollback_duas:
  stage: rollback
  image: williamyeh/ansible:alpine3
  before_script:
    - apk add --no-cache openssh-client python3 py3-pip
    - pip3 install ansible hvac
    - ansible-galaxy collection install community.hashi_vault

    # Setup SSH (key will be fetched by Ansible from Vault)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan -H ${TARGET_HOST} >> ~/.ssh/known_hosts 2>/dev/null || true
  script:
    - cd ansible
    - |
      ansible-playbook -i inventory.ini \
        playbooks/duas.yml \
        --tags rollback \
        -e "vault_addr=${VAULT_ADDR}" \
        -e "vault_token=${CI_JOB_JWT}" \
        -v
  only:
    - main
  when: manual
