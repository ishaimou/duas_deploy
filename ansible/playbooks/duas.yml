---
- name: Setup SSH key from Vault
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Fetch SSH private key from Vault
      set_fact:
        ssh_private_key: "{{ lookup('community.hashi_vault.hashi_vault', 'secret=secret/data/ssh/duas:private_key token={{ vault_token }} url={{ vault_addr }}') }}"
      no_log: true

    - name: Write SSH private key to file
      copy:
        content: "{{ ssh_private_key }}"
        dest: "~/.ssh/id_rsa"
        mode: "0600"
      no_log: true

- name: Deploy Dollar Universe Application Server 6.10
  hosts: duas_servers
  become: yes
  roles:
    - duas_install
